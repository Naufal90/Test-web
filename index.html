<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Login/Register Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>
        eruda.init();
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        input, button {
            margin: 5px;
            padding: 10px;
        }
        #console-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px;
            background: red;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h1>Test Login/Register Supabase</h1>

    <!-- Form Register -->
    <h2>Register</h2>
    <input type="email" id="register-email" placeholder="Email">
    <input type="password" id="register-password" placeholder="Password">
    <button onclick="register()">Daftar</button>
    <p id="register-message"></p>

    <!-- Form Login -->
    <h2>Login</h2>
    <input type="email" id="login-email" placeholder="Email">
    <input type="password" id="login-password" placeholder="Password">
    <button onclick="login()">Masuk</button>
    <p id="login-message"></p>

    <!-- Logout -->
    <h2>Logout</h2>
    <button onclick="logout()">Keluar</button>
    <p id="logout-message"></p>

    <!-- Tombol untuk membuka console di Android -->
    <button id="console-btn">Buka Console</button>

    <script>
    const SUPABASE_URL = "https://iafrlxyoeostvhnoywnv.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Register dengan gamertag
    async function register() {
        const email = document.getElementById("register-email").value;
        const password = document.getElementById("register-password").value;
        const gamertag = document.getElementById("register-gamertag").value;

        console.log("[DEBUG] Mendaftar dengan email:", email, "dan gamertag:", gamertag);

        const { data, error } = await supabase.auth.signUp({ email, password });

        if (error) {
            console.error("[ERROR] Register gagal:", error.message);
            document.getElementById("register-message").textContent = "Register gagal: " + error.message;
        } else {
            console.log("[DEBUG] Register berhasil:", data);

            // Simpan gamertag ke tabel "profiles"
            await supabase.from("profiles").insert([{ id: data.user.id, email, gamertag }]);

            document.getElementById("register-message").textContent = "Register berhasil! Cek email untuk verifikasi.";
        }
    }

    // Login dengan email atau gamertag
    async function login() {
        const identifier = document.getElementById("login-identifier").value;
        const password = document.getElementById("login-password").value;

        console.log("[DEBUG] Mencoba login dengan:", identifier);

        let email = identifier;

        // Jika user memasukkan gamertag, cari email dari database
        if (!identifier.includes("@")) {
            console.log("[DEBUG] Login menggunakan gamertag, mencari email...");
            const { data, error } = await supabase.from("profiles").select("email").eq("gamertag", identifier).single();

            if (error || !data) {
                console.error("[ERROR] Gamertag tidak ditemukan.");
                document.getElementById("login-message").textContent = "Gamertag tidak ditemukan.";
                return;
            }
            email = data.email;
        }

        // Login dengan email yang sudah ditemukan
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });

        if (error) {
            console.error("[ERROR] Login gagal:", error.message);
            document.getElementById("login-message").textContent = "Login gagal: " + error.message;
        } else {
            console.log("[DEBUG] Login berhasil:", data);
            document.getElementById("login-message").textContent = "Login berhasil!";
        }
    }
</script>

<!-- FORM -->
<h2>Register</h2>
<input type="email" id="register-email" placeholder="Email">
<input type="password" id="register-password" placeholder="Password">
<input type="text" id="register-gamertag" placeholder="Gamertag">
<button onclick="register()">Daftar</button>
<p id="register-message"></p>

<h2>Login</h2>
<input type="text" id="login-identifier" placeholder="Email atau Gamertag">
<input type="password" id="login-password" placeholder="Password">
<button onclick="login()">Masuk</button>
<p id="login-message"></p>
    
</body>
</html>
